<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Калькулятор дозировок антибиотиков (МНН) — по международным руководствам</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Минимум собственных стилей — GitHub Pages‑совместимо */
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:20px}
    .pill{display:inline-flex;align-items:center;gap:.5rem;padding:.125rem .5rem;border-radius:999px;font-size:.75rem;font-weight:600}
    .btn{border-radius:12px;padding:.625rem 1rem;background:#2563eb;color:#fff}
    .btn:hover{background:#1d4ed8}
    .btn-ghost{border-radius:12px;padding:.625rem 1rem;background:#eff6ff;color:#1d4ed8}
    .btn-ghost:hover{background:#dbeafe}
    .chip{display:inline-block;padding:.4rem .8rem;border-radius:999px;border:1px solid #cbd5e1;cursor:pointer;font-size:.875rem}
    .chip:hover{background:#f8fafc}
    .chip-active{background:#eff6ff;border-color:#93c5fd;color:#1d4ed8}
    .muted{color:#64748b}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    /* Чёткий переключатель Взрослый/Детский */
    .seg{display:inline-flex;border:1px solid #cbd5e1;border-radius:12px;overflow:hidden}
    .seg button{padding:.5rem 1rem;font-size:.875rem;background:#fff;color:#1f2937}
    .seg button.active{background:#2563eb;color:#fff}
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <header class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex items-start justify-between gap-4 flex-wrap">
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold">Калькулятор дозировок антибиотиков (МНН)</h1>
        <p class="text-sm muted mt-1">Практический инструмент для врачей. Только режимы из международных руководств (WHO AWaRe/EML, IDSA/ATS, AAP, NICE/BNF, UCSF IDMP). Без офф‑лейбла и без «додумок».</p>
      </div>
      <div class="flex items-center gap-2 text-xs">
        <span class="pill" style="background:#dcfce7;color:#166534">ACCESS</span>
        <span class="pill" style="background:#fef9c3;color:#92400e">WATCH</span>
        <span class="pill" style="background:#ffe4e6;color:#9f1239">RESERVE</span>
        <span class="muted">— категории WHO AWaRe</span>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-20">
    <!-- ВВОД ДАННЫХ -->
    <section class="card" aria-label="Исходные параметры">
      <div class="flex flex-wrap items-center gap-3">
        <div class="seg" role="tablist" aria-label="Возрастная группа">
          <button id="tabAdult" class="active" role="tab" aria-selected="true" aria-controls="panelAdult">Взрослый</button>
          <button id="tabPeds" role="tab" aria-selected="false" aria-controls="panelPeds">Детский</button>
        </div>
        <div class="seg" aria-label="AWaRe фильтр">
          <button class="active" data-aware-filter="all" type="button">Все</button>
          <button data-aware-filter="ACCESS" type="button">ACCESS</button>
          <button data-aware-filter="WATCH" type="button">WATCH</button>
        </div>
        <button id="reset" class="btn-ghost" type="button" title="Сбросить форму">Сброс</button>
        <div class="text-xs font-medium ml-auto" id="modeLabel">Режим: ВЗРОСЛЫЙ</div>
      </div>

      <div class="grid lg:grid-cols-3 gap-4 mt-4">
        <div>
          <label for="drug" class="block text-sm font-medium">Препарат (МНН)</label>
          <select id="drug" class="mt-1 w-full border rounded-lg px-3 py-2"></select>
          <div id="awareTag" class="mt-2 text-xs"></div>
        </div>
        <div>
          <label for="route" class="block text-sm font-medium">Путь введения</label>
          <select id="route" class="mt-1 w-full border rounded-lg px-3 py-2">
            <option value="PO">Per os (PO)</option>
            <option value="IV">В/в (IV)</option>
          </select>
        </div>
        <div>
          <label for="severity" class="block text-sm font-medium">Тяжесть</label>
          <select id="severity" class="mt-1 w-full border rounded-lg px-3 py-2">
            <option value="standard">Стандартная</option>
            <option value="severe">Тяжёлая</option>
            <option value="meningitis">Менингит (если применимо)</option>
          </select>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-4 mt-4" id="panelAdult" role="tabpanel" aria-labelledby="tabAdult">
        <div>
          <label for="age" class="block text-sm font-medium">Возраст (лет)</label>
          <input id="age" type="number" min="0" step="1" value="35" class="mt-1 w-full border rounded-lg px-3 py-2" />
        </div>
        <div>
          <label for="weight" class="block text-sm font-medium">Масса (кг)</label>
          <input id="weight" type="number" min="1" step="0.1" value="70" class="mt-1 w-full border rounded-lg px-3 py-2" />
        </div>
        <div>
          <label for="sex" class="block text-sm font-medium">Пол</label>
          <select id="sex" class="mt-1 w-full border rounded-lg px-3 py-2">
            <option value="M">М</option>
            <option value="F">Ж</option>
          </select>
        </div>
      </div>

      <div class="grid lg:grid-cols-2 gap-4 mt-4">
        <div>
          <label class="block text-sm font-medium">Почечная функция</label>
          <div class="grid md:grid-cols-2 gap-3 mt-1">
            <input id="egfr" type="number" step="1" placeholder="eGFR/ClCr (мл/мин), если известен" class="w-full border rounded-lg px-3 py-2" />
            <div class="grid grid-cols-2 gap-3">
              <input id="scr" type="number" step="0.01" placeholder="Креатинин" class="w-full border rounded-lg px-3 py-2" />
              <select id="scrUnit" class="w-full border rounded-lg px-3 py-2">
                <option value="mgdl">mg/dL</option>
                <option value="umol">µmol/L</option>
              </select>
            </div>
          </div>
          <p class="text-xs muted mt-1">Если eGFR/ClCr не введён: у взрослых — Cockcroft–Gault; у детей — формула Шварца (k=0.413) при указании роста.</p>
          <div id="pedsHtRow" class="hidden mt-2">
            <div class="grid grid-cols-2 gap-3">
              <input id="height" type="number" step="0.5" placeholder="Рост (см) для формулы Шварца" class="w-full border rounded-lg px-3 py-2" />
              <div class="text-xs muted flex items-center">eGFRдет = 0.413 × рост(см) / SCr(mg/dL)</div>
            </div>
          </div>
        </div>
        <div>
          <label for="hepatic" class="block text-sm font-medium">Печёночная недостаточность</label>
          <select id="hepatic" class="mt-1 w-full border rounded-lg px-3 py-2">
            <option value="none">Нет</option>
            <option value="mild">Лёгкая/умеренная</option>
            <option value="severe">Тяжёлая</option>
          </select>
          <label for="rounding" class="block text-sm font-medium mt-3">Округление дозы</label>
          <select id="rounding" class="mt-1 w-full border rounded-lg px-3 py-2">
            <option value="nearest">До ближайшей доступной</option>
            <option value="down">В меньшую сторону</option>
            <option value="up">В большую сторону</option>
          </select>
        </div>
      </div>

      <div class="mt-4 flex items-center gap-2">
        <button id="calc" class="btn" type="button">Рассчитать</button>
        <button id="copy" class="btn-ghost" type="button">Скопировать режим</button>
      </div>
    </section>

    <!-- КЛИНИЧЕСКИЕ ПРЕСЕТЫ (строгое именование согласно гайдам) -->
    <section class="card mt-6" aria-label="Клинические пресеты">
      <div class="flex items-center justify-between flex-wrap gap-2">
        <h2 class="text-xl font-semibold">Клинические пресеты (строго по руководствам)</h2>
        <div class="text-xs muted">Выбор пресета подставляет режимы и длительность из соответствующего протокола</div>
      </div>
      <div class="flex flex-wrap gap-2 mt-3" id="presetChips"></div>
      <div id="presetDrugs" class="mt-3 hidden"></div>
    </section>

    <!-- РЕЗУЛЬТАТ -->
    <section class="card mt-6" aria-live="polite" aria-atomic="true">
      <h2 class="text-xl font-semibold">Результат</h2>
      <div id="result" class="mt-3 text-sm"></div>
    </section>

    <!-- AWaRe ПОЯСНЕНИЕ -->
    <section class="card mt-6">
      <h3 class="font-semibold mb-2">Как использовать категории WHO AWaRe</h3>
      <ul class="list-disc ml-5 text-sm space-y-1">
        <li><b>ACCESS (зелёные):</b> препараты первой/второй линии для частых инфекций; цель систем здравоохранения — ≥60% потребления из этой группы.</li>
        <li><b>WATCH (жёлтые):</b> более высокий риск развития резистентности; применять, если ACCESS‑опции не подходят/противопоказаны или по протоколу.</li>
        <li><b>RESERVE (красные):</b> «последний рубеж» для МЛУ‑инфекций; намеренно не включены в этот базовый калькулятор.</li>
      </ul>
      <p class="text-xs muted mt-2">Клинические решения и локальные протоколы приоритетнее. Этот инструмент — справочный.</p>
    </section>

    <!-- ПРИМЕЧАНИЯ -->
    <section class="mt-6 text-xs text-slate-600">
      <div class="card">
        <h3 class="font-semibold mb-2">Принципы</h3>
        <ul class="list-disc ml-5 space-y-1">
          <li>Режимы и кратности — из международных руководств (WHO AWaRe/EML; IDSA/ATS; AAP; NICE/BNF; UCSF IDMP). В интерфейсе используются строгие названия пресетов согласно документам.</li>
          <li>eGFR: Cockcroft–Gault (взрослые) или формула Шварца (дети, при указании роста); либо используйте введённое eGFR/ClCr.</li>
          <li>Nitrofurantoin: избегать при eGFR &lt;30 мл/мин/1,73 м²; при 30–44 — только короткий курс 3–7 дней в исключительных случаях (MDR) с оценкой риска/пользы.</li>
        </ul>
        <p class="mt-2 text-[11px]">⚠️ Справочно. Проверяйте противопоказания, взаимодействия, беременность/лактацию, вакцинацию. Следуйте локальным протоколам.</p>
      </div>
    </section>
  </main>

<script>
// ===== УТИЛИТЫ =====
const byId = (x)=>document.getElementById(x);
function cockcroftGaultCrCl({age,weight,sex,scr,scrUnit}){ if(!age||!weight||!sex||!scr) return null; let scr_mgdl=scrUnit==='umol'?(scr/88.4):scr; if(scr_mgdl<=0) return null; let crcl=((140-age)*weight)/(72*scr_mgdl); if(sex==='F') crcl*=0.85; return Math.max(1,Math.round(crcl)); }
function schwartz({height, scr, scrUnit}){ if(!height||!scr) return null; let scr_mgdl = scrUnit==='umol'?(scr/88.4):scr; if(scr_mgdl<=0) return null; return Math.round(0.413*height/scr_mgdl); }
function formatDose(mg){ if(!mg && mg!==0) return ''; if(mg>=1000){ return (mg/1000).toFixed(2).replace(/\.00$/,'')+' g'; } return Math.round(mg)+' mg'; }
function hoursFromFreq(freq){ return Math.round(24/(freq||1)); }

// ===== AWaRe ТЭГИ =====
const AWARE = {
  amoxicillin:'ACCESS', amoxclav:'ACCESS', azithromycin:'WATCH', ceftriaxone:'WATCH',
  cephalexin:'ACCESS', cefuroxime:'WATCH', doxycycline:'ACCESS', tmpsmx:'ACCESS',
  ciprofloxacin:'WATCH', levofloxacin:'WATCH', metronidazole:'ACCESS', nitrofurantoin:'ACCESS'
};

function awareBadge(drug){ const group=AWARE[drug]; const map={ACCESS:'background:#dcfce7;color:#166534', WATCH:'background:#fef9c3;color:#92400e', RESERVE:'background:#ffe4e6;color:#9f1239'}; return group?`<span class="pill" style="${map[group]}">AWaRe: ${group}</span>`:''; }

// ===== БАЗА ПРЕПАРАТОВ (только on‑label из гайдов) =====
const DB = {
  amoxicillin:{ name:'Amoxicillin', routes:['PO'], adult:[ {key:'standard', dose_mg:500, freq:3, route:'PO'}, {key:'severe', dose_mg:1000, freq:3, route:'PO'} ], ped:{ perkg_perday_min:40, perkg_perday_max:90, freq:2, max_day_mg:4000 }, max_day_mg:4000, renal:[ {maxCrCl:10, change:{freq:1}}, {maxCrCl:30, change:{freq:2}} ], hepatic:{ severe:{ factor:1 } }, forms:['таб 250/500 mg; сусп 125/250 mg/5 mL'] },
  amoxclav:{ name:'Amoxicillin/Clavulanate', routes:['PO','IV'], adult:[ {key:'standard', dose_mg:875, freq:2, route:'PO'}, {key:'severe', dose_mg:2000, freq:2, route:'PO'} ], ped:{ perkg_perday_min:40, perkg_perday_max:90, freq:2, max_day_mg:4000, clav_limit_mgkgday:10 }, max_day_mg:4000, renal:[ {maxCrCl:10, change:{freq:1, cap875:true}}, {maxCrCl:30, change:{freq:2, cap875:true}} ], hepatic:{ severe:{ factor:1 } }, forms:['таб 250/125, 500/125, 875/125; XR 2000/125; сусп'] },
  azithromycin:{ name:'Azithromycin', routes:['PO','IV'], adult:[ {key:'standard', dose_mg:500, freq:1, route:'PO', pattern:'500 mg день 1, затем 250 mg 1×/сут дни 2–5'} ], ped:{ perkg_day1:10, perkg_day2_5:5, max_day1_mg:500, max_other_mg:250 }, max_day_mg:500, renal:[ {maxCrCl:0, change:{}} ], hepatic:{ severe:{factor:1} }, forms:['таб 250/500; сусп 200 mg/5 mL'] },
  ceftriaxone:{ name:'Ceftriaxone', routes:['IV'], adult:[ {key:'standard', dose_mg:1000, freq:1, route:'IV'}, {key:'severe', dose_mg:2000, freq:1, route:'IV'}, {key:'meningitis', dose_mg:2000, freq:2, route:'IV'} ], ped:{ perkg_perday_min:50, perkg_perday_max:100, freq:1, max_day_mg:4000, meningitis:{ perkg_perday:100, freq:2, max_day_mg:4000 } }, max_day_mg:4000, renal:[ {maxCrCl:0, change:{}} ], hepatic:{ severe:{ factor:1 } }, forms:['в/в флаконы 1 g, 2 g'] },
  cephalexin:{ name:'Cephalexin', routes:['PO'], adult:[ {key:'standard', dose_mg:500, freq:4, route:'PO'} ], ped:{ perkg_perday_min:25, perkg_perday_max:50, freq:3, max_day_mg:4000 }, max_day_mg:4000, renal:[ {maxCrCl:10, change:{freq:1}}, {maxCrCl:50, change:{freq:2}} ], hepatic:{ severe:{ factor:1 } }, forms:['таб/капс 250/500 mg; сусп 125/250 mg/5 mL'] },
  cefuroxime:{ name:'Cefuroxime (axetil, PO)', routes:['PO'], adult:[ {key:'standard', dose_mg:500, freq:2, route:'PO'} ], ped:{ perkg_perday_min:20, perkg_perday_max:30, freq:2, max_day_mg:1000 }, max_day_mg:1000, renal:[ {maxCrCl:30, change:{freq:1}} ], hepatic:{ severe:{ factor:1 } }, forms:['таб 250/500 mg'] },
  doxycycline:{ name:'Doxycycline', routes:['PO','IV'], adult:[ {key:'standard', dose_mg:100, freq:2, route:'PO'} ], ped:{ note:">=8 лет: 2.2 mg/kg q12h (день 1), затем 2.2 mg/kg q24h; макс 200 mg/сут" }, max_day_mg:200, renal:[ {maxCrCl:0, change:{}} ], hepatic:{ severe:{ factor:1 } }, forms:['таб/капс 100 mg'] },
  tmpsmx:{ name:'Trimethoprim/Sulfamethoxazole', routes:['PO','IV'], adult:[ {key:'standard', dose_mg:160, freq:2, route:'PO'} ], ped:{ perkg_perday_TMP:8, freq:2, max_day_mg_TMP:320 }, max_day_mg_TMP:320, renal:[ {maxCrCl:15, change:{ doseFactor:0.5, freq:1 }}, {maxCrCl:30, change:{ doseFactor:0.5 }} ], hepatic:{ severe:{ factor:1 } }, forms:['таб SS 80/400; DS 160/800'] },
  ciprofloxacin:{ name:'Ciprofloxacin', routes:['PO','IV'], adult:[ {key:'standard', dose_mg:500, freq:2, route:'PO'} ], ped:{ note:'У детей по строгим показаниям' }, max_day_mg:1500, renal:[ {maxCrCl:30, change:{freq:1}}, {maxCrCl:50, change:{}} ], hepatic:{ severe:{ factor:1 } }, forms:['таб 250/500/750 mg; р-р в/в 400 mg'] },
  levofloxacin:{ name:'Levofloxacin', routes:['PO','IV'], adult:[ {key:'standard', dose_mg:500, freq:1, route:'PO'}, {key:'severe', dose_mg:750, freq:1, route:'PO'} ], ped:{ note:'Обычно не используется без спец. показаний' }, max_day_mg:750, renal:[ {maxCrCl:20, change:{ schedule:'500 mg загрузка, затем 250 mg q48h (для режима 500); 750→500 q72h' }}, {maxCrCl:49, change:{ schedule:'500 mg загрузка, затем 250 mg q24h; 750→500 q48h' }} ], hepatic:{ severe:{ factor:1 } }, forms:['таб 250/500/750 mg'] },
  metronidazole:{ name:'Metronidazole', routes:['PO','IV'], adult:[ {key:'standard', dose_mg:500, freq:3, route:'PO'} ], ped:{ perkg_perdose:7.5, freq:3, max_day_mg:2000 }, max_day_mg:2000, renal:[ {maxCrCl:0, change:{}} ], hepatic:{ severe:{ factor:0.5 } }, forms:['таб/капс 250/500 mg; р-р в/в'] },
  nitrofurantoin:{ name:'Nitrofurantoin (macrocrystals/monohydrate)', routes:['PO'], adult:[ {key:'standard', dose_mg:100, freq:2, route:'PO'} ], ped:{ note:'У детей старшего возраста — по локальным протоколам' }, max_day_mg:200, renal:[ {maxCrCl:30, change:{ avoid:true }}, {maxCrCl:45, change:{ caution:true }} ], hepatic:{ severe:{ factor:1 } }, forms:['капс/таб 50/100 mg'] }
};

// ===== ПРЕСЕТЫ (строгое именование; длительности из протоколов) =====
const PRESETS = {
  cap_adult: {
    title:'CAP у взрослых без коморбидностей — IDSA/ATS 2019',
    duration:'5 дней при клинической стабилизации',
    options:[
      {drug:'amoxicillin', regimen:{dose_mg:1000, freq:3, route:'PO'}},
      {drug:'doxycycline', regimen:{dose_mg:100, freq:2, route:'PO'}},
      {drug:'azithromycin', regimen:{pattern:'500 mg день 1, затем 250 mg q24h дни 2–5', route:'PO'}}
    ]
  },
  strep_adult: {
    title:'Острый стрептококковый фарингит — IDSA/CDC',
    duration:'10 дней',
    options:[
      {drug:'amoxicillin', regimen:{dose_mg:500, freq:2, route:'PO'}},
      {drug:'cephalexin', regimen:{dose_mg:500, freq:2, route:'PO'}}
    ]
  },
  aom_child: {
    title:'Острый средний отит у детей — AAP 2013',
    duration:'5–10 дней (по возрасту/тяжести)',
    options:[
      {drug:'amoxicillin', ped:{perkg_perday:90, freq:2, max_day_mg:4000}},
      {drug:'amoxclav', ped:{perkg_perday:90, freq:2, max_day_mg:4000}}
    ]
  },
  sinusitis_adult: {
    title:'Острый бактериальный риносинусит — IDSA/NICE',
    duration:'5–7 дней',
    options:[
      {drug:'amoxclav', regimen:{dose_mg:875, freq:2, route:'PO'}},
      {drug:'doxycycline', regimen:{dose_mg:100, freq:2, route:'PO'}}
    ]
  },
  cystitis_woman: {
    title:'Неосложнённый цистит у женщин — IDSA 2011',
    duration:'Nitrofurantoin 5 дней; TMP/SMX 3 дня (при местной резистентности ≤20%)',
    options:[
      {drug:'nitrofurantoin', regimen:{dose_mg:100, freq:2, route:'PO'}},
      {drug:'tmpsmx', regimen:{dose_mg:160, freq:2, route:'PO'}}
    ]
  },
  cellulitis_adult: {
    title:'Негнойный целлюлит — IDSA 2014',
    duration:'5 дней при клиническом ответе',
    options:[
      {drug:'cephalexin', regimen:{dose_mg:500, freq:4, route:'PO'}},
      {drug:'amoxicillin', regimen:{dose_mg:500, freq:3, route:'PO'}}
    ]
  },
  pyelo_woman: {
    title:'Острый неосложнённый пиелонефрит (женщины) — IDSA 2011',
    duration:'Ciprofloxacin 7 дней; Levofloxacin 5 дней; TMP/SMX 14 дней (при чувствительности)',
    options:[
      {drug:'ciprofloxacin', regimen:{dose_mg:500, freq:2, route:'PO'}},
      {drug:'levofloxacin', regimen:{dose_mg:750, freq:1, route:'PO'}},
      {drug:'tmpsmx', regimen:{dose_mg:160, freq:2, route:'PO'}}
    ]
  },
  mrsa_ssti_outpt: {
    title:'Гнойные SSTI (вне стационара) — IDSA 2014',
    duration:'5–10 дней + обязательное дренирование',
    options:[
      {drug:'tmpsmx', regimen:{dose_mg:160, freq:2, route:'PO'}},
      {drug:'doxycycline', regimen:{dose_mg:100, freq:2, route:'PO'}}
    ]
  },
  hpylori_empiric: {
    title:'H. pylori (эмпирическая терапия) — ACG 2024',
    duration:'14 дней',
    options:[
      {drug:'metronidazole', regimen:{pattern:'Оптимизированная квадротерапия: PPI 2×/сут + Bismuth 4×/сут + Tetracycline 500 mg 4×/сут + Metronidazole 500 mg 3–4×/сут × 14 дней'}}
    ]
  },
  meningitis_child: {
    title:'Бактериальный менингит (эмпирическая терапия, дети) — UCSF/ID',
    duration:'Согласно диагнозу/возбудителю',
    options:[
      {drug:'ceftriaxone', regimen:{pattern:'Ceftriaxone 50 mg/kg/dose IV q12h (макс 2000 mg/доза) + добавить Vancomycin по TDM; рассмотреть Ampicillin при риске Listeria'}}
    ]
  }
};
const PRESET_ORDER = ['cap_adult','strep_adult','aom_child','sinusitis_adult','cystitis_woman','cellulitis_adult','pyelo_woman','mrsa_ssti_outpt','hpylori_empiric','meningitis_child'];

// ===== РАСЧЁТ =====
function applyRenal(drugKey, regimen, egfr){
  const rules=(DB[drugKey].renal||[]).sort((a,b)=>a.maxCrCl-b.maxCrCl); let notes=[]; if(!egfr||egfr<=0) return {regimen, notes};
  for(const r of rules){ if(r.maxCrCl===0){ continue; } if(egfr<=r.maxCrCl){ if(r.change){ if(r.change.freq) regimen.freq=r.change.freq; if(r.change.doseFactor) regimen.dose_mg=Math.round((regimen.dose_mg||0)*(r.change.doseFactor)); if(r.change.cap875&&regimen.dose_mg>=875) regimen.dose_mg=500; if(r.change.schedule) notes.push(r.change.schedule); if(r.change.avoid) notes.push('Противопоказан при текущем eGFR'); if(r.change.caution) notes.push('Только короткий курс 3–7 дней при eGFR 30–44, если ожидаемая польза превышает риск'); }
    break; } }
  return {regimen, notes}; }
function applyHepatic(drugKey, regimen, hepatic){ const h=DB[drugKey].hepatic?.[hepatic]; let notes=[]; if(h){ if(h.factor&&h.factor!==1){ regimen.dose_mg=Math.round((regimen.dose_mg||0)*h.factor);} } return {regimen, notes}; }
function capByMax(drugKey, regimen){ const max=DB[drugKey].max_day_mg; let notes=[]; if(max){ const perDay=(regimen.dose_mg||0)*(regimen.freq||1); if(perDay>max){ const newDose=Math.floor(max/(regimen.freq||1)); if(newDose>0){ regimen.dose_mg=newDose; notes.push(`Ограничено макс. суточной дозой: ${formatDose(max)}/сут.`); } } } return {regimen, notes}; }
function roundPractical(regimen, rounding){ const steps=[62.5,125,200,250,400,500,625,750,875,1000,1500,2000]; let nearest=steps.reduce((best,s)=>Math.abs((regimen.dose_mg||0)-s)<Math.abs((regimen.dose_mg||0)-best)?s:best, steps[0]); if(rounding==='up'&&nearest<(regimen.dose_mg||0)) nearest=steps.find(s=>s>=(regimen.dose_mg||0))||regimen.dose_mg; if(rounding==='down'&&nearest>(regimen.dose_mg||0)) nearest=[...steps].reverse().find(s=>s<=(regimen.dose_mg||0))||regimen.dose_mg; regimen.dose_mg=nearest; return regimen; }

function calcAdult(drugKey, severity, egfr, hepatic, rounding, baseReg=null){ let reg= baseReg ? {...baseReg} : (DB[drugKey].adult.find(x=>x.key===severity)||DB[drugKey].adult[0]); reg={...reg}; const renal=applyRenal(drugKey,{...reg},egfr); reg=renal.regimen; let notes=[...renal.notes]; const hep=applyHepatic(drugKey,reg,hepatic); reg=hep.regimen; notes.push(...hep.notes); const cap=capByMax(drugKey,reg); reg=cap.regimen; notes.push(...cap.notes); if(reg.dose_mg) reg=roundPractical(reg,rounding); return {reg, notes}; }

function calcPeds(drugKey, weight){ const d=DB[drugKey]; if(!d.ped) return {text:'Нет педиатрического режима в калькуляторе'}; if(drugKey==='azithromycin'){ const d1=Math.min(d.ped.max_day1_mg, Math.round(weight*d.ped.perkg_day1)); const d2=Math.min(d.ped.max_other_mg, Math.round(weight*d.ped.perkg_day2_5)); return {text:`День 1: ${d1} mg 1×; Дни 2–5: ${d2} mg 1×`}; } if(drugKey==='doxycycline'){ return {text:d.ped.note}; } if(drugKey==='tmpsmx'){ const perDayTMP=Math.min(d.ped.max_day_mg_TMP, Math.round(weight*d.ped.perkg_perday_TMP)); const perDoseTMP=Math.round(perDayTMP/d.ped.freq); return {text:`TMP ${perDoseTMP} mg q${Math.round(24/d.ped.freq)}h (в сутки: ${perDayTMP} mg TMP)`}; } if(d.ped.perkg_perdose){ const perDose=Math.round(weight*d.ped.perkg_perdose); return {text:`${perDose} mg q${Math.round(24/d.ped.freq)}h`}; } const perDayMin=Math.round(weight*d.ped.perkg_perday_min); const perDayMax=Math.round(weight*d.ped.perkg_perday_max); const perDoseMin=Math.round(perDayMin/d.ped.freq); const perDoseMax=Math.round(perDayMax/d.ped.freq); const maxDay=d.ped.max_day_mg?`; макс: ${d.ped.max_day_mg} mg/сут`:''; let extra=''; if(d.ped.clav_limit_mgkgday){ extra=`; клавуланат ≤ ${d.ped.clav_limit_mgkgday} mg/кг/сут`; } return {text:`${perDoseMin}–${perDoseMax} mg q${Math.round(24/d.ped.freq)}h (в сутки: ${perDayMin}–${perDayMax} mg${maxDay}${extra})`}; }

function buildAlert(lines){ if(!lines||!lines.length) return ''; return `<div class="mt-3 p-3 rounded-xl border border-amber-200" style="background:#fffbeb;color:#78350f"><div class="font-semibold">Примечания</div><ul class="list-disc ml-5">${lines.map(x=>`<li>${x}</li>`).join('')}</ul></div>`; }

function renderResult({drug, route, regimen, notes, isPeds, pedsText, egfr, duration, presetTitle}){
  let html = `<div class=\"text-base font-semibold flex items-center gap-2\">${DB[drug].name} ${awareBadge(drug)}</div>`;
  if(regimen.pattern){ html += `<div class=\"mono mt-1\">${regimen.pattern}${duration?` • Длительность: ${duration}`:''}</div>`; }
  else if(regimen.dose_mg){ html += `<div class=\"mono mt-1\">${formatDose(regimen.dose_mg)} каждые ${hoursFromFreq(regimen.freq)} ч${regimen.route?` (${regimen.route})`:''}${duration?` • Длительность: ${duration}`:''}</div>`; }
  if(DB[drug].forms){ html += `<div class=\"text-xs muted mt-1\">Формы: ${DB[drug].forms.join('; ')}</div>`; }
  if(!isPeds){ html += `<div class=\"mt-4\"><div class=\"text-base font-semibold\">Дети (справочно):</div><div class=\"mono\">${pedsText}</div></div>`; }
  else { html += `<div class=\"mt-4\"><div class=\"text-base font-semibold\">Дети:</div><div class=\"mono\">${pedsText}</div></div>`; }
  if(egfr){ html += `<div class=\"mt-4 text-xs muted\">Расчётная почечная функция: <span class=\"font-semibold\">${egfr} мл/мин</span></div>`; }
  html += buildAlert(notes);
  if(presetTitle){ html += `<div class=\"mt-4 text-xs muted\">Пресет: ${presetTitle}</div>`; }
  html += `<div class=\"mt-4 text-[11px]\">⚠️ Справочный инструмент. Следуйте официальным протоколам и локальным документам.</div>`;
  byId('result').innerHTML = html;
}

function populateDrugs(filter='all'){
  const sel=byId('drug'); sel.innerHTML='';
  Object.keys(DB).forEach(k=>{ const grp=AWARE[k]||'ACCESS'; if(filter!=='all' && grp!==filter) return; const opt=document.createElement('option'); opt.value=k; opt.textContent=DB[k].name; sel.appendChild(opt); });
  updateAwareTag();
}
function updateAwareTag(){ const d=byId('drug').value; byId('awareTag').innerHTML = awareBadge(d); const routeSel=byId('route'); if(!DB[d].routes.includes(routeSel.value)){ routeSel.value=DB[d].routes[0]; } }

function onCalc(overrides=null){
  const drug=byId('drug').value; const route=byId('route').value; const age=parseInt(byId('age').value,10); const weight=parseFloat(byId('weight').value); const sex=byId('sex').value; const severity=byId('severity').value; const egfrInput=parseFloat(byId('egfr').value); const scr=parseFloat(byId('scr').value); const scrUnit=byId('scrUnit').value; const hepatic=byId('hepatic').value; const rounding=byId('rounding').value; const isPeds=age<18;
  let egfr=isFinite(egfrInput)?egfrInput:null; if((!egfr||egfr<=0)&&scr>0){ if(isPeds){ const ht=parseFloat(byId('height').value); const eg=schwartz({height:ht, scr, scrUnit}); if(eg) egfr=eg; } else { egfr=cockcroftGaultCrCl({age,weight,sex,scr,scrUnit}); } }
  let baseReg = overrides?.regimen || null; const {reg, notes} = calcAdult(drug, severity, egfr, hepatic, rounding, baseReg);
  if(route && reg.route && route!==reg.route){ /* строго не меняем режим, только предупреждаем */ notes.push('Выбранный путь введения отличается от рекомендованного для пресета'); }
  const p = calcPeds(drug, weight);
  renderResult({drug, route, regimen: reg.pattern?reg:reg, notes, isPeds, pedsText:p.text, egfr, duration: overrides?.duration || null, presetTitle: overrides?.title || null});
}

function makePresetChips(){ const box=byId('presetChips'); box.innerHTML=''; PRESET_ORDER.forEach(key=>{ const p=PRESETS[key]; const span=document.createElement('span'); span.className='chip'; span.textContent=p.title; span.onclick=()=>showPresetOptions(key); box.appendChild(span); }); }
function showPresetOptions(key){ const holder=byId('presetDrugs'); holder.classList.remove('hidden'); const p=PRESETS[key]; holder.innerHTML = `<div class=\"text-sm muted\">${p.title}. Рекомендуемые режимы:</div>` + `<div class=\"flex flex-wrap gap-2 mt-2\">` + p.options.map((o,i)=>`<button class=\"chip ${i===0?'chip-active':''}\" data-drg=\"${o.drug}\" data-key=\"${key}\" type=\"button\">${DB[o.drug] ? DB[o.drug].name : 'Комбинированный режим'}</button>`).join('') + `</div>` + `<div class=\"text-xs mt-2\">Длительность: <span class=\"font-medium\">${p.duration}</span></div>`;
  holder.querySelectorAll('button').forEach(btn=>{ btn.onclick=()=>{ holder.querySelectorAll('button').forEach(b=>b.classList.remove('chip-active')); btn.classList.add('chip-active'); const d=btn.getAttribute('data-drg'); if(DB[d]){ byId('drug').value=d; updateAwareTag(); }
    const opt=PRESETS[key].options.find(x=>x.drug===d) || PRESETS[key].options[0]; const overrides={ regimen: opt.regimen||null, duration:p.duration, title:p.title }; onCalc(overrides); }; }); }

function copyRegimen(){ const res=byId('result'); if(!res.innerText) return; navigator.clipboard.writeText(res.innerText).then(()=>{ byId('copy').textContent='Скопировано'; setTimeout(()=>byId('copy').textContent='Скопировать режим',1500); }); }

// ===== СВЯЗЬ С UI =====
byId('calc').addEventListener('click', ()=>onCalc());
byId('copy').addEventListener('click', copyRegimen);
byId('drug').addEventListener('change', updateAwareTag);
byId('reset').addEventListener('click', ()=>{ window.location.reload(); });

// Переключение Adult/Peds — фикс яркой подсветки
function setTab(isAdult){ const a=byId('tabAdult'), p=byId('tabPeds'); if(isAdult){ a.classList.add('active'); p.classList.remove('active'); a.setAttribute('aria-selected','true'); p.setAttribute('aria-selected','false'); byId('pedsHtRow').classList.add('hidden'); byId('modeLabel').textContent='Режим: ВЗРОСЛЫЙ'; } else { p.classList.add('active'); a.classList.remove('active'); p.setAttribute('aria-selected','true'); a.setAttribute('aria-selected','false'); byId('pedsHtRow').classList.remove('hidden'); byId('modeLabel').textContent='Режим: ДЕТСКИЙ'; } }
byId('tabAdult').addEventListener('click', ()=>setTab(true));
byId('tabPeds').addEventListener('click', ()=>setTab(false));

// Фильтр AWaRe
Array.from(document.querySelectorAll('[data-aware-filter]')).forEach((btn,idx)=>{ if(idx===0) btn.classList.add('active'); btn.addEventListener('click',()=>{ Array.from(document.querySelectorAll('[data-aware-filter]')).forEach(b=>b.classList.remove('active')); btn.classList.add('active'); populateDrugs(btn.getAttribute('data-aware-filter')); }); });

// ===== ИНИЦИАЛИЗАЦИЯ =====
populateDrugs('all'); makePresetChips(); updateAwareTag();
</script>
</body>
</html>
